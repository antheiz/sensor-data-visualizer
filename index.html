<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Sensor Data Visualizer</title>
    <!-- Gunakan versi Chart.js UMD -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/4.1.0/cdn.min.js"
        integrity="sha512-bz58Sg3BAWMEMPTH0B8+pK/+5Qfqq6b2Ho2G4ld12x4fiUVqpY8jSbN/73qpBQYFLU4QnKVL5knUm4uqcJGLVw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="icon" href="favicon.ico" />
    <style>
        /* CSS untuk gaya loading spinner */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            display: none;
        }

        /* Indikator spinner loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>

    <!-- Form Input untuk BASE_URL, API_KEY, dan Page Size -->
    <div>
        <label for="baseUrl">Base URL:</label>
        <input type="text" id="baseUrl" placeholder="Masukkan Base URL">

        <label for="apiKey">API Key:</label>
        <input type="text" id="apiKey" placeholder="Masukkan API Key">

        <label for="pageSize">Page Size:</label>
        <input type="number" id="pageSize" placeholder="Masukkan Page Size" min="1" value="1000">

        <button onclick="fetchMeasurements('3h')">3 Jam Terakhir</button>
        <button onclick="fetchMeasurements('12h')">12 Jam Terakhir</button>
        <button onclick="fetchMeasurements('3d')">3 Hari Terakhir</button>
        <button onclick="fetchMeasurements('7d')">7 Hari Terakhir</button>
    </div>

    <!-- Elemen Canvas untuk Chart -->
    <canvas id="aqmsChart"></canvas>

    <!-- Indikator Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <script>
        let chart = null; // Variabel global untuk menyimpan chart

        /**
         * Fungsi untuk memformat tanggal dengan mikrodetik.
         * @param {Date} date - Objek Date yang akan diformat.
         * @returns {string} - String tanggal dalam format ISO dengan mikrodetik.
         */
        function formatDateWithMicroseconds(date) {
            const pad = (n) => n.toString().padStart(2, '0');
            const padMicro = (n) => n.toString().padStart(6, '0');

            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const seconds = pad(date.getSeconds());
            const microseconds = padMicro(Math.floor(Math.random() * 1000000));

            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}.${microseconds}Z`;
        }

        /**
         * Menghitung rentang tanggal berdasarkan filter waktu.
         * @param {string} timeFilter - Filter waktu (misalnya: '3h', '12h', '3d', '7d').
         * @returns {Object} - Objek dengan start_date dan end_date.
         */
        function calculateDateRange(timeFilter) {
            const now = new Date();
            let startDate;

            switch (timeFilter) {
                case '3h':
                    startDate = dateFns.subHours(now, 3);
                    break;
                case '12h':
                    startDate = dateFns.subHours(now, 12);
                    break;
                case '3d':
                    startDate = dateFns.subDays(now, 3);
                    break;
                case '7d':
                    startDate = dateFns.subDays(now, 7);
                    break;
                default:
                    startDate = dateFns.subHours(now, 3);
            }

            return {
                start_date: formatDateWithMicroseconds(startDate),
                end_date: formatDateWithMicroseconds(now)
            };
        }

        /**
         * Mengambil data pengukuran dari API dan menampilkan chart.
         * @param {string} timeFilter - Filter waktu untuk rentang pengukuran.
         */
        async function fetchMeasurements(timeFilter) {
            const baseUrl = document.getElementById('baseUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const pageSize = document.getElementById('pageSize').value;

            if (!baseUrl || !apiKey || !pageSize) {
                alert('Harap masukkan Base URL, API Key, dan Page Size.');
                return;
            }

            console.log(`Filter dipilih: ${timeFilter}`);

            const { start_date, end_date } = calculateDateRange(timeFilter);
            console.log(`Start Date: ${start_date}, End Date: ${end_date}`);

            let allMeasurements = [];
            let page = 1;
            let hasMore = true;

            // Tampilkan indikator loading
            document.getElementById('loading').style.display = 'block';

            try {
                while (hasMore) {
                    const url = new URL(`${baseUrl}/v1/stations/measurements/`);
                    url.searchParams.set('start_date', start_date);
                    url.searchParams.set('end_date', end_date);
                    url.searchParams.set('page_size', pageSize);
                    url.searchParams.set('page', page);

                    console.log(`Fetching from URL: ${url.toString()}`);
                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Response error:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const pageData = await response.json();
                    allMeasurements = allMeasurements.concat(pageData.results);

                    // Check if there are more pages
                    hasMore = pageData.next !== null;
                    page++;
                }

                console.log('All Measurements:', allMeasurements);

                // Hapus indikator loading setelah data selesai di-fetch
                document.getElementById('loading').style.display = 'none';

                createChart(allMeasurements);

            } catch (error) {
                console.error('Error fetching measurements:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        /**
         * Membuat atau memperbarui chart berdasarkan data pengukuran.
         * @param {Array} measurements - Data pengukuran yang diambil dari API.
         */
        function createChart(measurements) {
            // Hancurkan chart sebelumnya jika ada
            if (chart) {
                chart.destroy();
            }

            const timestamps = measurements.map(item => new Date(item.timestamp));
            const values = measurements.map(item => item.value);

            const ctx = document.getElementById('aqmsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Measurement Value',
                        data: values,
                        borderColor: 'blue',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>
